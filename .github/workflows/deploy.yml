# ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤.
name: Frontend CI/CD Pipeline

# ===================================================================
#  1. ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´ (Trigger)
# ===================================================================
# â˜…â˜…â˜…â˜…â˜… ë³¸ì¸ì˜ í”„ë¡ íŠ¸ì—”ë“œ ê¸°ë³¸ ë¸Œëœì¹˜ ì´ë¦„ì´ 'main'ì´ë¼ë©´ ì•„ë˜ 'master'ë¥¼ ëª¨ë‘ 'main'ìœ¼ë¡œ ìˆ˜ì •í•˜ì„¸ìš”! â˜…â˜…â˜…â˜…â˜…
on:
  # 1. main ë¸Œëœì¹˜ì— ì§ì ‘ push í•  ë•Œ
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'  # ëª¨ë“  ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ë¬´ì‹œ
      - 'docs/**'  # docs í´ë” ì•„ë˜ì˜ ëª¨ë“  ë³€ê²½ ë¬´ì‹œ

  # 2. main ë¸Œëœì¹˜ë¡œ Pull Requestê°€ merge ë  ë•Œ
  pull_request:
    types: [ closed ] # PRì´ ë‹«í˜”ì„ ë•Œ (merged ë˜ëŠ” unmerged)
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'

# ===================================================================
#  2. ì‹¤í–‰ë  ì‘ì—… (Jobs)
# ===================================================================
jobs:
  build-and-deploy:
    # Pull Requestê°€ 'Merge' ë˜ì—ˆì„ ë•Œë§Œ ì´ ì‘ì—…ì„ ì‹¤í–‰í•˜ë„ë¡ ì¡°ê±´ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    # ì´ ì‘ì—…ì€ GitHubê°€ ì œê³µí•˜ëŠ” ìµœì‹  ìš°ë¶„íˆ¬ ê°€ìƒ ì„œë²„ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    runs-on: ubuntu-latest

    # ì‘ì—… ì•ˆì—ì„œ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ë  ë‹¨ê³„(Steps)ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
    steps:
      # -------------------------------------------------------------------
      #  ë‹¨ê³„ 1: ì†ŒìŠ¤ ì½”ë“œ ì¤€ë¹„
      # -------------------------------------------------------------------
      # GitHub ì €ì¥ì†Œì˜ ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ìƒ ì„œë²„ ì•ˆìœ¼ë¡œ ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤.
      - name: Checkout Source Code
        uses: actions/checkout@v3
      
      # -------------------------------------------------------------------
      #  ë‹¨ê³„ 2: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hubì— ì—…ë¡œë“œ
      # -------------------------------------------------------------------
      # GitHub Secretsë¥¼ ì‚¬ìš©í•˜ì—¬ Docker Hubì— ë¡œê·¸ì¸í•©ë‹ˆë‹¤.
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ë””ë²„ê¹… í• ë•Œ, .env.development íŒŒì¼ì„ ì œê±°í•˜ì—¬ .env.production íŒŒì¼ì„ ì‚¬ìš©í•˜ë„ë¡ í•©ë‹ˆë‹¤.
      - name: Prepare for Production Build
        run: |
          echo "Removing .env.development to ensure production-only settings are used."
          rm -f .env.development

      # Dockerfileì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³ , Docker Hubì— í‘¸ì‹œ(ì—…ë¡œë“œ)í•©ë‹ˆë‹¤.
      # ì´ ê³¼ì • ì•ˆì—ì„œ Dockerfileì˜ ì§€ì‹œì— ë”°ë¼ ìë™ìœ¼ë¡œ npm install ë° npm run buildê°€ ì¼ì–´ë‚©ë‹ˆë‹¤.
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          # â˜…â˜…â˜…â˜…â˜… 'my-app-frontend'ë¥¼ ë³¸ì¸ì´ ë§Œë“  Docker Hub ë ˆí¬ì§€í† ë¦¬ ì´ë¦„ìœ¼ë¡œ ìˆ˜ì •í•˜ì„¸ìš”! â˜…â˜…â˜…â˜…â˜…
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/3thproject-front:latest
          no-cache: true

          # ğŸ‘‡ğŸ‘‡ğŸ‘‡ ì´ ë¶€ë¶„ì„ ì¶”ê°€í•˜ì—¬ ë¹Œë“œ ì¸ìë¥¼ ì§ì ‘ ì£¼ì…í•©ë‹ˆë‹¤. ğŸ‘‡ğŸ‘‡ğŸ‘‡
          # "NEXT_PUBLIC_API_BASE_URL ë³€ìˆ˜ì˜ ê°’ì€ ë¹ˆ ë¬¸ìì—´("")ì´ì•¼!" ë¼ê³  ê°•ì œí•©ë‹ˆë‹¤.
          build-args: |
            NEXT_PUBLIC_API_BASE_URL=""

      # -------------------------------------------------------------------
      #  ë‹¨ê³„ 3: EC2 ì„œë²„ì— ë°°í¬
      # -------------------------------------------------------------------
      # EC2 ì„œë²„ì— SSHë¡œ ì›ê²© ì ‘ì†í•˜ì—¬ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
      - name: Deploy to EC2 Instance
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.AWS_HOST_IP }}
          username: ${{ secrets.AWS_HOST_USERNAME }}
          key: ${{ secrets.AWS_SSH_PRIVATE_KEY }}
          script: |
            cd ~/app
            
            # EC2 ì„œë²„ì˜ docker-compose.ymlì´ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í™˜ê²½ë³€ìˆ˜ë¥¼ export í•©ë‹ˆë‹¤.
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            
            # Docker Hubì—ì„œ ìµœì‹  ë²„ì „ì˜ í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œ(pull)í•©ë‹ˆë‹¤.
            docker compose pull frontend
            
            # ìµœì‹  ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡ íŠ¸ì—”ë“œ ì»¨í…Œì´ë„ˆë¥¼ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.
            docker compose up -d frontend
            
            # ë¶ˆí•„ìš”í•˜ê²Œ ë‚¨ì€ ì´ì „ ë²„ì „ì˜ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì—¬ ì„œë²„ ìš©ëŸ‰ì„ í™•ë³´í•©ë‹ˆë‹¤.
            docker image prune -f
